!function(_,c){_(document).on("ready",function(){var o={append_spinner:function(e){return!(!e||!e.append||(e.append('<span class="urm-spinner is-active"></span>'),0))},remove_spinner:function(e){return!(!e||!e.remove||(e.find(".urm-spinner").remove(),0))},convert_to_array:function(e){return Object.values(e).reverse().slice(2).reverse()},toggleSaveButtons:function(e,t){e=this.if_empty(e,!0),_(t).prop("disabled",!!e)},if_empty:function(e,t){return null===e||undefined===e||""===e?t:e},clear_validation_error:function(){_("span.notice_red").each(function(){_(this).text("")})},show_validation_error:function(e,t){e.removeClass("notice_blue").addClass("notice_red").text(t),this.clear_validation_error();e.siblings("input");_("html, body").animate({scrollTop:e.parent().offset().top},200),e.text(t)},toggleNotice:function(){_(".notice-container").toggleClass("active"),setTimeout(this.toggleNotice,5e3)},show_failure_message:function(e){_(".notice-container .notice_blue").removeClass("notice_blue").addClass("notice_red"),_(".notice_message").text(e),this.toggleNotice()},show_success_message:function(e){_(".notice-container .notice_red").removeClass("notice_red").addClass("notice_blue"),_(".notice_message").text(e),this.toggleNotice()},isEventRegistered:function(e,t){e=_._data(_(e)[0],"events");return e&&e[t]}},i={prepare_members_data:function(){var t={},e=_("#ur-membership-registration").find("input.ur_membership_input_class"),e=((e=o.convert_to_array(e)).forEach(function(e){e=_(e);name=e.attr("name").toLowerCase().replace("urm_",""),t[name]=e.val()}),_('input[name="urm_membership"]:checked')),e=(t.membership=e.val(),(t.payment_method="free")!==e.data("urm-pg-type")&&(t.payment_method=_('input[name="urm_payment_method"]:checked').val()),new Date);return t.start_date=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate(),t},prepare_coupons_apply_data:function(){var e={};return e.coupon=_("#ur-membership-coupon").val(),e.membership_id=_('input[name="urm_membership"]:checked').val(),e},validate_membership_form:function(){var e,t=_("#ur-membership-registration").find("input"),r=new RegExp("^[a-zA-Z0-9._%+-]+@(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,}$"),s=!0;return(t=o.convert_to_array(t)).every(function(e){var e=_(e),t=e.val(),n=e.attr("required"),a=e.data("key-name"),e=e.siblings(".notice_red");return n&&""===t?(s=!1,o.show_validation_error(e,c.labels.i18n_error+"! "+a+" "+c.labels.i18n_field_is_required),!1):!("Email"===a&&!r.test(t)&&(s=!1,o.show_validation_error(e,c.labels.i18n_field_email_field_validation),1))}),s&&(0===_('input[name="urm_membership"]:checked').length&&(s=!1,o.show_failure_message(c.labels.i18n_error+"! "+c.labels.i18n_membership_required)),t=_('input[name="urm_payment_method"]:visible'),(e=0)<t.length&&(t.each(function(){_(this).prop("checked")||e++}),t.length===e)&&(s=!1,o.show_validation_error(_("#payment-gateway-notice"),c.labels.i18n_field_payment_gateway_field_validation)),s)&&o.clear_validation_error(),s},validate_coupon_data:function(){var e=_("#ur-membership-coupon").val(),t=_('input[name="urm_membership"]:checked'),n=_("#coupon-validation-error"),a=!0;return o.clear_validation_error(),e.length<1?(a=!1,o.show_validation_error(n,c.labels.i18n_error+"! "+c.labels.i18n_coupon_empty_error)):0===t.length?(a=!1,o.show_validation_error(n,c.labels.i18n_error+"! "+c.labels.i18n_membership_required)):"free"===t.data("urm-pg-type")&&(a=!1,o.show_validation_error(n,c.labels.i18n_error+"! "+c.labels.i18n_coupon_free_membership_error)),a},create_member:function(e){var t;o.toggleSaveButtons(!0,e),o.append_spinner(e),this.validate_membership_form()?(t=this.prepare_members_data(),this.send_data({action:"user_registration_membership_register_member",members_data:JSON.stringify(t)},{success:function(e){e.success?i.handle_response(e,t):o.show_failure_message(e.data.message)},failure:function(e,t){o.show_failure_message(c.labels.network_error+"("+t+")")},complete:function(){o.remove_spinner(e),o.toggleSaveButtons(!1,e)}})):(o.remove_spinner(e),o.toggleSaveButtons(!1,e))},handle_response:async function(e,t){switch(t.payment_method){case"paypal":o.show_success_message(e.data.message),window.location.replace(e.data.pg_data.payment_url);break;case"bank":o.show_success_message(e.data.message),this.show_bank_response(e,t);break;case"stripe":await r.handle_stripe_response(e,t);break;default:o.show_success_message(e.data.message),this.show_default_response({username:t.username})}},show_bank_response:function(e,t){var n=c.thank_you_page_url,e={transaction_id:e.data.transaction_id,payment_type:"unpaid",info:e.data.pg_data.data,username:t.username},t=_.param(e).toString();window.location.replace(n+"?"+t)},show_default_response:function(e){var t=c.thank_you_page_url,e=_.param(e).toString();window.location.replace(t+"?"+e)},validate_coupon:function(e){o.toggleSaveButtons(!0,e),o.append_spinner(e),this.validate_coupon_data()?this.send_data({action:"user_registration_membership_validate_coupon",coupon_data:this.prepare_coupons_apply_data()},{success:function(e){e.success?i.handle_coupon_validation_response(e):o.show_failure_message(e.data.message)},failure:function(e,t){500===e.status?o.show_failure_message(c.labels.network_error+"("+t+")"):o.show_validation_error(_("#coupon-validation-error"),c.labels.i18n_error+"! "+e.responseJSON.data.message)},complete:function(){o.remove_spinner(e),o.toggleSaveButtons(!1,e)}}):(o.toggleSaveButtons(!1,e),o.remove_spinner(e))},handle_coupon_validation_response:function(e){_(".urm_apply_coupon").hide(),o.clear_validation_error(),_("#coupon-validation-error").removeClass("notice_red").addClass("notice_blue").text(e.data.message),e=JSON.parse(e.data.data);var t=_('input[name="urm_membership"]:checked');t.attr("data-ur-discount-amount",e.discount_amount),i.calculate_total(t),t="fixed"===e.coupon_details.coupon_discount_type?c.currency_symbol+""+e.coupon_details.coupon_discount:e.coupon_details.coupon_discount+"%",_("#total-input-notice").text(t+" "+c.labels.i18n_coupon_discount_message)},send_data:function(e,t){var n="function"==typeof t.success?t.success:function(){},a="function"==typeof t.failure?t.failure:function(){},r="function"==typeof t.beforeSend?t.beforeSend:function(){},t="function"==typeof t.complete?t.complete:function(){};!e._wpnonce&&c&&(e._wpnonce=c._nonce),_.ajax({type:"post",dataType:"json",url:c.ajax_url,data:e,beforeSend:r,success:n,error:a,complete:t})},calculate_total:function(e){var t=e.data("urm-pg-calculated-amount"),n=_("#ur-membership-total"),e=e.data("ur-discount-amount"),e=e!==undefined&&""!==e?t-e:t;n.val(c.currency_symbol+e)}},r={elements:{},show_stripe_error:function(e){0<$membership_registration_form.find("#stripe-errors").length?$membership_registration_form.find("#stripe-errors").html(e):(e='<label id="stripe-errors" class="notice_red" role="alert">'+e+"</label>",$membership_registration_form.find(".stripe-container").parents(".ur_membership_frontend_input_container").append(e))},init:function(){elements=r.setupElements(),$membership_registration_form=_("#ur-membership-registration"),this.triggerInputChange()},triggerInputChange:function(){elements.card.addEventListener("change",function(e){e.error?r.show_stripe_error(e.error.message):0<$membership_registration_form.find("#stripe-errors").length&&$membership_registration_form.find("#stripe-errors").remove()})},setupElements:function(){var e=Stripe(c.stripe_publishable_key),t=e.elements(),n={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"14px","::placeholder":{color:"#8f9194"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},a=t.create("card",{style:n}),n=t.create("idealBank",{style:n});return a.mount("#card-element"),{stripe:e,card:a,ideal:n,clientSecret:""}},handle_stripe_response:function(e,t){"paid"===e.data.pg_data.type?this.handle_one_time_payment(e,t):this.handle_recurring_payment(e,{paymentElements:elements,user_id:e.data.member_id,response_data:e,prepare_members_data:t})},handle_one_time_payment:function(n,a){elements.stripe.confirmCardPayment(n.data.pg_data.client_secret,{payment_method:{card:elements.card}}).then(function(e){var t=_(".membership_register_button");o.toggleSaveButtons(!0,t),o.append_spinner(t),r.update_order_status(e,n,a)})},update_order_status:function(t,e,n){i.send_data({_wpnonce:c._confirm_payment_nonce,action:"user_registration_membership_confirm_payment",members_data:JSON.stringify(n),member_id:e.data.member_id,payment_status:t.error?"failed":"succeeded"},{success:function(e){e.success?(o.show_success_message(e.data.message),i.show_default_response({username:n.username,transaction_id:t.paymentIntent.id})):o.show_failure_message(e.data.message)},failure:function(e,t){o.show_failure_message(c.labels.network_error+"("+t+")")},complete:function(){var e=_(".membership_register_button");o.toggleSaveButtons(!1,e),o.remove_spinner(e)}})},handle_recurring_payment:function(n,a){Promise.resolve(_.extend({},a,{customer_id:n.data.pg_data.stripe_cus_id})).then(r.createPaymentMethod).then(r.createSubscription).then(r.handleCustomerActionRequired).then(r.handleOnComplete)["catch"](function(e,t){r.update_order_status({error:{}},n,a.prepare_members_data)})},createPaymentMethod:function(a){return new Promise(function(t,n){var e=_(".membership_register_button");o.toggleSaveButtons(!0,e),o.append_spinner(e),a.paymentElements.stripe.createPaymentMethod({type:"card",card:a.paymentElements.card}).then(function(e){e.error?n(e.error.message,e):t(_.extend({},a,{payment_method_id:e.paymentMethod.id}))})["catch"](function(e){n(e,result)})})},createSubscription:function(s){return new Promise(function(a,r){i.send_data({_wpnonce:c._confirm_payment_nonce,action:"user_registration_membership_create_stripe_subscription",member_id:s.user_id,customer_id:s.customer_id,payment_method_id:s.payment_method_id},{success:function(e){var t,n;e.success?(t=e.data.subscription.latest_invoice.payment_intent,e.error?(n=e.error.message,r(n,s)):("trialing"!==e.data.subscription.status&&t&&"requires_payment_method"===t.status&&r(e,n="Your card was declined"),a(_.extend({},s,{subscription:e.data.subscription,message:e.data.message})))):r(e,n)},failure:function(e,t){o.show_failure_message(c.labels.network_error+"("+t+")")}})})},handleCustomerActionRequired:function(r){return new Promise(function(n,a){!r.subscription||"active"!==r.subscription.status&&"trialing"!==r.subscription.status||n({subscription:r.subscription,response_data:r.response_data,message:r.message,prepare_members_data:r.prepare_members_data});var e=r.subscription.latest_invoice.payment_intent;"trialing"!==r.subscription.status&&"requires_action"===e.status&&r.paymentElements.stripe.confirmCardPayment(e.client_secret,{payment_method:r.paymentMethodId}).then(function(e){var t;e.error?(t=e.error.message,a(t,r)):"succeeded"===e.paymentIntent.status?(r.subscription.status="active",n({subscription:r.subscription,form_id:r.form_id,response_data:r.response_data})):a(t="Unable to complete the payment.",r)})})},handleOnComplete:function(e){var t;!e.subscription||"active"!==e.subscription.status&&"trialing"!==e.subscription.status||(t=_(".membership_register_button"),o.toggleSaveButtons(!1,t),o.remove_spinner(t),o.show_success_message(e.message),i.show_default_response({username:e.prepare_members_data.username,transaction_id:e.subscription.id}))}};_('input[name="urm_membership"]').on("change",function(){_("#total-input-notice").text("");var a=_(this).data("urm-pg"),e=_(this).data("urm-pg-type"),t=_(".ur_payment_gateway_container").find("input"),n=_(".urm_hidden_payment_container");n.addClass("urm-d-none"),_(".urm_apply_coupon").show(),"free"!==e&&(n.removeClass("urm-d-none"),t.each(function(e,t){var t=_(t).val(),n=_('label[for="ur-membership-'+t+'"]');n.removeClass("urm-d-none"),a.hasOwnProperty(t)||n.addClass("urm-d-none")}),i.calculate_total(_(this)))}),new URLSearchParams(window.location.search).has("membership_id")&&_('input[name="urm_membership"]:checked').change(),_(".close_notice").on("click",o.toggleNotice),_("#ur-membership-password").on("keyup change",function(){var e=_(this).val(),t=_("#password-notice"),n=new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_+}{\"':;?/>.<,]).*$");if(o.show_validation_error(t,""),e.length<8)o.show_validation_error(t,c.labels.i18n_field_password_field_length_validation);else{if(n.test(e))return!0;o.show_validation_error(t,c.labels.i18n_field_password_field_regex_validation)}}),_("#ur-membership-confirm-password").on("keyup",function(){var e=_(this).val(),t=_("#ur-membership-password").val(),n=_("#confirm-password-notice");if(o.show_validation_error(n,""),0===t.length&&o.show_validation_error(n,c.labels.i18n_field_password_empty_validation),e===t)return!0;o.show_validation_error(n,c.labels.i18n_field_confirm_password_field_validation)}),_(document).on("click",".membership_register_button",function(e){var t=_(this);e.preventDefault(),e.stopPropagation(),i.create_member(t)}),_(document).on("click",".urm_apply_coupon",function(){i.validate_coupon(_(this))}),_(document).on("click",".ur_clear_coupon",function(){_("#ur-membership-coupon").val(""),_("#coupon-validation-error").text(""),_(".urm_apply_coupon").show(),_("#total-input-notice").text("");var e=_('input[name="urm_membership"]:checked');e.removeData("ur-discount-amount").removeAttr("data-ur-discount-amount"),i.calculate_total(e)}),_(document).on("click",".membership-signup-button",function(){var e=_(this).siblings("input").val(),e=c.membership_registration_page_url+"?membership_id="+e;window.location.replace(e)}),_('input[name="urm_payment_method"]').on("change",function(){var e=_(this).val(),t=_(".stripe-container");t.addClass("urm-d-none"),elements={},"stripe"===e&&(t.removeClass("urm-d-none"),r.init())})})}(jQuery,window.ur_membership_frontend_localized_data);